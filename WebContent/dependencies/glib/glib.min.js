//  Copyright 2014 Grzegorz Gurgul gurgul.grzegorz@gmail.com
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.

(function(e,t,n){if(typeof module!=="undefined")module.exports=n(e,t);else if(typeof define==="function"&&typeof define.amd==="object")define(n);else t[e]=n(e,t)})("JMF",this,function(e,t){var n=true;var r=function(){var e={off:0,fatal:1,error:2,warning:3,info:4,all:5};var t=[];var n="Unnamed log";var r=e["error"];var i=false;var s=r;var o=">";var u=">";var a=function(e,t){this.tag=e||n;this.level=t||r};a.prototype.setLevel=function(t){typeof t=="string"&&(t=e[t]);this.level=t};a.prototype.log=function(t,n){var r,a;if(typeof t=="string"){r=t;a=e[r]}else{r=function(){for(name in e)if(e[name]==t)return name}()}if(i&&t<s||this.level>t)return;console.log(t+u+this.tag+o+n)};return{createLog:function(e,n){var r=new a(e,n);t.push(r);return r},setDefaultLevel:function(e){e&&(r=e)},enforceLevel:function(e){i=true;s=e},dropLevelEnforcement:function(){i=false}}}();if(n){r.setDefaultLevel("verbose");r.enforceLevel("all")}var i=r.createLog(e);var s=function(e){var t="MISSING_RESOURCE";var n="WRONG_ARGUMENT";var r=function(e,t){this.name=e;this.message=t};r.prototype=new Error;r.prototype.constructor=r;var i={};i[t]=function(e){return new r(t,"Resource "+e+" could not be found")};i[n]=function(e){return new r(n,"Argument "+e+" is not a valid one for this function.")};return i}(i);var o=function(e){var t={};var n=function(){};var r=Array.prototype.slice;var i=Object.prototype.hasOwnProperty;var s=Array.prototype.forEach;var o=Object.keys;var u=Function.prototype.bind;var a=Array.prototype.some;var f=Array.prototype.indexOf;if(typeof /./!=="function"){var c=function(e){return typeof e==="function"}}var h=0;var p=function(e){var t=++h+"";return e?e+t:t};var d=function(e,t){return(e.length-e.replace(new RegExp(t,"g"),"").length)/t.length};var v=function(e,t){return i.call(e,t)};var m=o||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e){if(v(e,n))t.push(n)}return t};var g=function(e){if(e===null)return 0;return e.length===+e.length?e.length:m(e).length};var y=function(e,t){var i,s;if(e.bind===u&&u)return u.apply(e,r.call(arguments,1));if(!c(e))throw new TypeError;i=r.call(arguments,2);return s=function(){if(!(this instanceof s))return e.apply(t,i.concat(r.call(arguments)));ctor.prototype=e.prototype;var o=new n;n.prototype=null;var u=e.apply(o,i.concat(r.call(arguments)));if(Object(u)===u)return u;return o}};var b=function(e,n,r){if(e===null)return;if(s&&e.forEach===s){e.forEach(n,r)}else if(e.length===+e.length){for(var i=0;l=e.length,i<l;i++){if(n.call(r,e[i],i,e)===t)return}}else{for(var o in e){if(v(e,o)){if(n.call(r,e[o],o,e)===t)return}}}};var w=function(e,t){var n=document.createElement("script");n.src=e;var r=false;n.onreadystatechange=function(){if(n.readyState==="loaded"||n.readyState==="complete"){n.onreadystatechange=null;if(r)return;r=true;t(n)}};n.onload=function(){if(r)return;r=true;t(n)};document.head.appendChild(n)};var E=function(e,t){filenode=document.createElement("link");filenode.rel="stylesheet";filenode.type="text/css";filenode.href=e;document.head.appendChild(filenode);t(filenode)};var S=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,true);n.onreadystatechange=function(){if(n.readyState===4){if(n.status===200){t&&t(txtFile.responseText,true)}else t&&t("",false)}};n.send(null)};var x=function(e,t,n){var r=0;var i=g(t);b(t,function(t,s){e.call(this,t,function(e){++r>=i?n(s,true,e):n(s,false,e)})})};return{requireScript:w,requireStylesheet:E,requireText:S,requireAll:x,size:g,generateUniqueId:p,each:b,bind:y}}();var u=t["ns"]={};var a=function(){var e=function(e){this.name=e;this.children=[];this.asLeaf=false};e.prototype.getName=function(){return this.name};e.prototype.setHandler=function(e){this.handler=e};e.prototype.getHandler=function(){return this.handler};e.prototype.getObject=function(){return this.obj};e.prototype.setObject=function(e){this.obj=e};e.prototype.setData=function(e){this.data=e};e.prototype.getData=function(){return this.data};e.prototype.setAsLeaf=function(e){this.asLeaf=e};e.prototype.isLeaf=function(){return this.asLeaf};e.prototype.remove=function(){var e=this.children;var t=this.parent;for(var n=0;n<e.length;n++){e[n].parent=t}delete this};e.prototype.createChild=function(t){var n=new e(t);n.parent=this;n.handler=this.handler;this.children.push(n);return n};e.prototype.getParent=function(){return this.parent};e.prototype.findChildByName=function(e,t){if(this.name===e)return this;else if(this.asLeaf&&t){return undefined}else{for(var n,r=0;r<this.children.length;r++){if((n=this.children[r].findChildByName(e))!==undefined){return n}}return undefined}};e.prototype.findParent=function(e){if(e(this))return this;else return this.parent.findParent(e)};e.prototype.findChild=function(e){if(e(this))return this;else{for(var t,n=0;n<this.children.length;n++){if(t=this.children[n].findChild(e)){return t}}return undefined}};return e}();var f=function(e,t){var n;if(t instanceof Function){n=t(this)}else{n=t}if(n instanceof Object){this[e]=n}};var c=function(){this["container"]=new a("container");this["sources"]=new a("sources");this["factories"]=new a("factories")};var h=c.prototype["Node"]=a;var p=c.prototype["Logger"]=r;var f=function(e,t){if(t instanceof Function){var n=t(this);n&&(this[e]=n)}else{this[e]=t}};var d=c.prototype["create"]=function(e,t,n){i.log("debug","Creating object "+e);var r;var s=false;try{var u=this["sources"].findChildByName(e);var a=u.getHandler();var f=t?e:o.generateUniqueId();var l=this["container"].createChild(f);r=a.create(u,n,function(e,t,n){(n?l.findChildByName(n):l).createChild(e).setObject(t)});s=true}catch(c){i.log("error","Fatal error in creation process: Missing resource.");i.log(c.stack)}finally{if(!s){}}l.setObject(r);l.setAsLeaf(true);return r};var v=c.prototype["inject"]=function(e,t){i.log("debug","Injecting "+e);var n;if(e instanceof Object){n=this["container"].findChild(function(t){return t.getObject()===e?true:false}).getParent().findChildByName(t,false)}else if(!(n=this["container"].findChildByName(e))){return d.call(this,e,true)}return n.getObject()};var m=c.prototype["remove"]=function(e,t){i.log("debug","Removing "+e);if(obj=this["container"].findChildByName(e)){obj.remove()}};var g=c.prototype["require"]=function(e,n,r){i.log("debug","Loading module "+e);if(this[e]){i.log("debug","Module "+e+" has already been included. Skipping.");return}var s=this;o.requireScript(n,function(){f.call(s,e,t[e]);r&&r()})};var y=c.prototype["include"]=function(e,t){if(this[e]){i.log("debug","Module "+e+" has already been included. Skipping.");return}f.call(this,e,t);delete t};var b=c.prototype["includeAll"]=function(e,t,n){if(e.length<1){t&&t();return}var n=n||"./";var r=o.size(e);for(moduleName in e){if(this[moduleName])continue;if(typeof e[moduleName]==="string"){g.call(this,moduleName,n+e[moduleName],o.bind(function(e){i.log("verbose","Loaded module "+e+", to go: "+r);if(--r==0){t&&t()}},this,moduleName))}else{y.call(this,moduleName,e[moduleName]);if(--r==0)t&&t()}}};var w=c.prototype["includeEvery"]=function(e,t,n){if(e.length<1){t&&t();return}if(e instanceof Array){var r=0;var s=this;var o=function(e,u){b.call(s,e[u],function(){i.log("Loading module block "+r+"/"+e.length);if(e.length-1>u){o.call(s,e,u+1)}else{i.log("All blocks have been loaded successfully");t&&t()}},n)};o(e,0);i.log("All "+r-1+" blocks are being loaded one after another.")}else{b.call(this,e,function(){i.log("Loading single module block");i.log("All blocks have been loaded successfully");t&&t()},n)}};var E=c.prototype["loadScript"]=function(e,t){o.requireScript(e,t)};var S=c.prototype["loadAllScript"]=function(e,t){o.requireAll(o.requireScript,e,t)};return{createInstance:function(){return new c},loadScript:E,loadAllScript:S}});(function(e,t,n){if(typeof module!=="undefined")module.exports=n(e,t,$);else if(typeof define==="function"&&typeof define.amd==="object")define(n);else t[e]=n(e,t,JMF,$)})("JVC",this,function(e,t,n,r){var i=true;var s="./";var o=function(){var e="MISSING_RESOURCE";var t="WRONG_ARGUMENT";var n=function(e,t){this.name=e;this.message=t};n.prototype=new Error;n.prototype.constructor=n;var r={};r[e]=function(t){return new n(e,"Resource "+t+" could not be found")};r[t]=function(e){return new n(t,"Argument "+e+" is not a valid one for this function.")};return r}();var u=function(){var e={};var t=function(){};var n=Array.prototype.slice;var r=Object.prototype.hasOwnProperty;var i=Array.prototype.forEach;var s=Object.keys;var o=Function.prototype.bind;var u=Array.prototype.some;var a=Array.prototype.indexOf;if(typeof /./!=="function"){var f=function(e){return typeof e==="function"}}var c=0;var h=function(e){var t=++c+"";return e?e+t:t};var p=function(e,t){return e.split(t)};var d=function(e){var t=p(e,":");return t[t.length-1]};var v=function(e){var t=p(e,":");if(t.length>1)return t[t.length-2];else return""};var m=function(e,t){return(e.length-e.replace(new RegExp(t,"g"),"").length)/t.length};var g=function(e,t){return r.call(e,t)};var y=s||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e){if(g(e,n))t.push(n)}return t};var b=function(e){if(e===null)return 0;return e.length===+e.length?e.length:y(e).length};var w=function(e,r){var i,s;if(e.bind===o&&o)return o.apply(e,n.call(arguments,1));if(!f(e))throw new TypeError;i=n.call(arguments,2);return s=function(){if(!(this instanceof s))return e.apply(r,i.concat(n.call(arguments)));ctor.prototype=e.prototype;var o=new t;t.prototype=null;var u=e.apply(o,i.concat(n.call(arguments)));if(Object(u)===u)return u;return o}};var E=function(t,n,r){n||(n=_.identity);var i=false;if(t==null)return i;if(u&&t.some===u)return t.some(n,r);C(t,function(t,s,o){if(i||(i=n.call(r,t,s,o)))return e});return!!i};var S=function(e,t,n){var r;E(e,function(e,i,s){if(t.call(n,e,i,s)){r=e;return true}});return r};var x=function(e,t){if(e==null)return false;if(a&&e.indexOf===a)return e.indexOf(t)!=-1;return E(e,function(e){return e===t})};var T=function(e,t){if(!(e&&t))return false;if(a&&t.indexOf===a)return t.indexOf(e);for(key in e){if(t===e[item])return key}return-1};var N=function(e){var t="";var n=",";var r=y(e);var i=r.length;for(var s=0;s<i;s++){t+=r[s];if(s<i-1)t+=n}return t};var C=function(t,n,r){if(t===null)return;if(i&&t.forEach===i){t.forEach(n,r)}else if(t.length===+t.length){for(var s=0;l=t.length,s<l;s++){if(n.call(r,t[s],s,t)===e)return}}else{for(var o in t){if(g(t,o)){if(n.call(r,t[o],o,t)===e)return}}}};var k=function(e,t,n,r){if(!(e&&t))return false;var i;C(t,function(s){if((i=!e[s])&&(e[s]=t[s])){n&&n.call(r||this,t[s],s,i)}},r||this);return true};var L=function(e,t,n,r){if(!(e&&t))return false;var i,s;C(t,function(o){(s=tellPosition(e,t[o]))>0?e[s].remove():i=false;n.call(r||this,t[o],o,i);i=true},r||this);return true};var A=function(e){if(!e)throw"Cannot augment undefined object!";sources=n.call(arguments,1);C(sources,function(t){for(property in t){if(!g(e,property)){e[property]=t[property]}}});return e};var O=function(e){if(e==null||typeof e!="object")return e;var t=e.constructor();for(var n in e)t[n]=O(e[n]);return t};var M=function(e,t,n){return fn()?true&&t():setTimeout(function(){return waitUntil(e,t,n)},n)};return{delay:M,has:g,any:E,clone:O,augment:A,size:b,getPrefix:v,getSuffix:d,generateUniqueId:h,findKey:T,findValue:S,containsValue:x,listProperties:N,addAll:k,removeAll:L,each:C,bind:w,slice:n,hasOwnProperty:r}}();return function(){var e=n.createInstance();var r=e["Logger"];if(i){r.setDefaultLevel("verbose");r.enforceLevel("all")}var a=r.createLog("JVC");var f={create:u.bind(e["create"],e),inject:u.bind(e["inject"],e)};e.includeAll({Logger:r,Util:u,Exception:o});return function(){var n="getModelBuilder";var r="getControllerBuilder";var i="getViewBuilder";var l="templatePath";var c={};var h=0;var p=function(){this[n]={};this[r]={};this[i]={};this[l]="";return this}.call({});var d=function(n,r){function s(e){if(!e)throw new o["MissingResource"]("Could not load file");e.onLoad&&e.onLoad();i(e)}var i=this;if(typeof n==="string"&&n[0]==="@"){var u=p[l]+n.slice(1);e["Timer"].stepForward(r);e.loadScript(u,function(){s(t[r]);e["Timer"].stepBackward(r)})}else s(n)};var v=function(e,t){var n=this;u.each(e,function(e,t){n[t](e)})};c.loadConfig=function(e){v.call(c,e)};c.getConfig=function(){return p};c[l]=function(e,t){e&&d.call(function(e){p[l]=e;t&&t()},e,l)};var m;c[n]=function(t,r){if(!m){var i=p[n];m=e["ModelTemplate"].getBuilder(i,d)}t&&v.call(m,t,r);return m};var g;c[i]=function(t,n){if(!g){var r=p[i];g=e["ViewTemplate"].getBuilder(r,d)}t&&v.call(g,t,n);return g};var y;c[r]=function(t,n){if(!y){var i=p[r];y=e["ControllerTemplate"].getBuilder(i,d)}t&&v.call(y,t,n);return y};return{plugIn:function(t,n,r){a.log("Plugging in "+t);if(n instanceof String)e.require(t,n,r);else e.include(t,n)},load:function(t,n,r){r||(r={});var i=arguments[2]||{};var o=u.slice(arguments,3)||{};s=t.componentPath;e.includeEvery({configuration:function(e){}},function(){e.includeEvery(o,function(){e.includeEvery([{Timer:r["Timer"]||function(e){var t=e["Logger"].createLog("Timer module");t.log("debug","Preparing manager");var n=e["Timer"]={};var r="";var i=100;var s=0;var o=n["stepForward"]=function(e){t.log("verbose","Will wait for "+e);r+=e+" ";s++};var u=n["stepBackward"]=function(e){t.log("verbose","No longer waiting for "+e);r=r.split(e).pop();s--};var a=n["wait"]=function(e){console.log("clock: "+s);if(s>0)setTimeout(function(){if(i--<1){i=100;t.log("warn","These actions are blocking the execution: "+r);return}a(e)},25);else{e&&e()}}},ModelTemplate:r["ModelTemplate"]||"ModelTemplate.js",ViewTemplate:r["ViewTemplate"]||"ViewTemplate.js",ControllerTemplate:r["ControllerTemplate"]||"ControllerTemplate.js"},{ModelFactory:r["ModelFactory"]||"ModelFactory.js",ViewFactory:r["ViewFactory"]||"ViewFactory.js",ControllerFactory:r["ControllerFactory"]||"ControllerFactory.js"}],n,s)},s)},s)},getBuilder:function(e){if(!!c){var t=function(){this[n]={setSuperType:{Component:"@"+s+"/Component.js"},addModels:{ChangeSupport:"@"+s+"/ChangeSupport.js"}};this[r]={};this[i]={};this[l]="./";return this}.call({});config=!!!e?t:function(){this[r]=e[r]||t[r];this[n]=e[n]||t[n];this[i]=e[i]||t[i];this[l]=e[l]||t[l];return this}.call({});c.loadConfig(config)}return c},ready:function(t){e["Timer"].wait(t)},construct:function(){e["ModelTemplate"].construct();e["ControllerTemplate"].construct();e["ViewTemplate"].construct();return f}}}()}()})